<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Bricks Break</title>
    <style media="screen">
      #BBGame{
        border: 1px solid;
      }
    </style>
  </head>
  <body>
    <canvas id="BBGame" width="600" height="600"></canvas>
    <script>
      var log = console.log.bind(console)
      var rangeExtre = (l, r, x) => {
        l = Math.min(l, r)
        r = Math.max(l, r)
        if (x <= l){
          return l
        } else if (r <= x) {
          return r
        } else {
          return x
        }
      }
      var distence = (x1, y1, x2, y2) => {
        var dx = x1 - x2
        var dy = y1 - y2
        return Math.sqrt(dx * dx + dy * dy)
      }
      var dot = (x1, y1, x2, y2) => {
        return x1 * x2 + y1 * y2
      }
      var closestPoint = (x, y, x1, y1, x2, y2) => {
        if (x1 == x2) {
          return [x1, rangeExtre(y1, y2, y)]
        } else if (y1 == y2) {
          return [rangeExtre(x1, x2, x), y1]
        }
      }
      class GameObject {
        constructor(x, y, w, h) {
          this.x = x
          this.y = y
          this.w = w
          this.h = h
          this.vx = 0
          this.vy = 0
          this.alive = true
        }
        move() {
          this.x += this.vx
          this.y += this.vy
        }
        draw(ctx) {
          ctx.beginPath()
          ctx.rect(this.x - this.w, this.y - this.h, this.w * 2, this.h * 2)
          ctx.stroke()
        }
        collide(dx, dy, w, h) {
          if (dy * w >= dx * h) {
            this.vy *= -1
          }
          if (dy * w <= dx * h) {
            this.vx *= -1
          }
        }
        collideWith(gobj) {
          var dx = Math.abs(this.x - gobj.x)
          var dy = Math.abs(this.y - gobj.y)
          if (dx <= this.w + gobj.w && dy <= this.h + gobj.h) {
            // console.log(dx, dy, gobj, this.vx, this.vy);
            this.collide(dx, dy, gobj.w, gobj.h)
            return true
          }
          return false
        }
      }
      class Paddle extends GameObject {
        constructor(x, y, w = 100, h = 5) {
          super(x, y, w, h)
          this.collided = false
        }
        moveLeft() {
          if (this.x - this.w <= 0) {
            this.stop()
          } else {
            this.vx = -5
          }
        }
        moveRight() {
          if (this.x + this.w >= 600) {
            this.stop()
          } else {
            this.vx = 5
          }
        }
        stop() {
          this.vx = 0
        }
        collide(){
          this.stop()
        }
      }
      class Ball extends GameObject {
        constructor(x, y, r = 5){
          super(x, y, r, r)
          this.r = r
        }
        fire() {
          if (this.vx || this.vy){
            return
          }
          this.vy = -5
          this.vx = 5
        }
        draw(ctx){
          ctx.beginPath()
          ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI)
          ctx.stroke()
        }
      }
      class Brick extends GameObject {
        constructor(x, y) {
          super(x, y, 40, 20)
        }
        collide() {
          this.alive = false
        }
        draw(ctx) {
          if (!this.alive) {
            return
          }
          super.draw(ctx)
        }
      }
      class Game {
        constructor(fps) {
          this.cvs = document.getElementById('BBGame')
          this.ctx = this.cvs.getContext('2d')
          this.bounds = [
            new GameObject(
              this.cvs.width / 2,
              -this.cvs.height / 2,
              this.cvs.width / 2,
              this.cvs.height / 2),
            new GameObject(
              this.cvs.width / 2,
              this.cvs.height * 3 / 2,
              this.cvs.width / 2,
              this.cvs.height / 2),
            new GameObject(
              -this.cvs.width / 2,
              this.cvs.height / 2,
              this.cvs.width / 2,
              this.cvs.height / 2),
            new GameObject(
              this.cvs.width * 3 / 2,
              this.cvs.height / 2,
              this.cvs.width / 2,
              this.cvs.height / 2),
          ]
          this.paddle = new Paddle(100, 550)
          this.ball = new Ball(150, 540)
          this.bricks = [new Brick(10, 10), new Brick(30, 50)]
          this.gobjs = [...this.bounds, this.paddle, ...this.bricks]
          this.fps = fps
          window.addEventListener('keydown', event => {
            console.log(event);
            if(event.key == ' ') {
              this.ball.fire()
            } else if (event.key == 'ArrowLeft') {
              this.paddle.moveLeft()
            } else if (event.key == 'ArrowRight') {
              this.paddle.moveRight()
            }
          })
          window.addEventListener('keyup', event => {
            if (event.key == 'ArrowLeft') {
              this.paddle.stop()
            } else if (event.key == 'ArrowRight') {
              this.paddle.stop()
            }
          })
        }
        collisionCheck() {
          this.gobjs.forEach(obj => {
            if (obj.alive && this.ball.collideWith(obj)) {
              obj.collide()
            }
          })
          this.bounds.forEach(obj => {
            this.paddle.collideWith(obj)
          })
        }
        update() {
          this.paddle.move()
          this.ball.move()
          this.collisionCheck()
          this.draw()
          setTimeout(()=>{
            this.update()
          },1000/this.fps)
        }
        draw() {
          this.ctx.clearRect(0,0,this.cvs.width,this.cvs.height)
          this.paddle.draw(this.ctx)
          this.ball.draw(this.ctx)
          this.bricks.forEach(b => {
            b.draw(this.ctx)
          })
        }
        start() {
          this.update()
        }
      }
      var __main__ = function(){
        game = new Game(60)
        game.start()
      }
      __main__()
    </script>
  </body>
</html>
